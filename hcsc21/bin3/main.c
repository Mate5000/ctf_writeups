/* This file has been generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2018 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

__int64 (**init_proc())(void);
__int64 sub_401020();
// char *strncpy(char *dest, const char *src, size_t n);
// int strncmp(const char *s1, const char *s2, size_t n);
// int puts(const char *s);
// size_t strlen(const char *s);
// int printf(const char *format, ...);
// void *memset(void *s, int c, size_t n);
// int getchar(void);
// __int64 __fastcall gets(_QWORD); weak
// void *dlopen(const char *file, int mode);
// __gid_t getegid(void);
// int dlclose(void *handle);
// int setregid(__gid_t rgid, __gid_t egid);
// __int64 __fastcall __isoc99_scanf(_QWORD, _QWORD); weak
// void *dlsym(void *handle, const char *name);
// void __usercall __noreturn start(__int64 a1@<rax>, void (*a2)(void)@<rdx>);
void *deregister_tm_clones();
__int64 register_tm_clones();
void *_do_global_dtors_aux();
__int64 __fastcall frame_dummy(_QWORD, _QWORD, _QWORD); // weak
signed __int64 __fastcall check(const char *a1);
__int64 stuff();
int __cdecl main(int argc, const char **argv, const char **envp);
void __fastcall _libc_csu_init(unsigned int a1, __int64 a2, __int64 a3);
void _libc_csu_fini(void); // idb
void term_proc();
// int __cdecl _libc_start_main(int (__cdecl *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end);
// __int64 _gmon_start__(void); weak

//-------------------------------------------------------------------------
// Data declarations

char algn_40113B[5] = { '\x0F', '\x1F', 'D', '\0', '\0' }; // weak
__int64 (__fastcall *_frame_dummy_init_array_entry)() = &frame_dummy; // weak
__int64 (__fastcall *_do_global_dtors_aux_fini_array_entry)() = &_do_global_dtors_aux; // weak
__int64 (*qword_404010)(void) = NULL; // weak
_BYTE n2m[32] =
{
  43,
  3,
  42,
  52,
  23,
  55,
  123,
  68,
  93,
  3,
  2,
  1,
  5,
  5,
  6,
  2,
  43,
  64,
  86,
  12,
  53,
  32,
  27,
  54,
  76,
  12,
  82,
  83,
  21,
  53,
  98,
  24
}; // idb
char byte_4040E0 = 'i'; // weak
char byte_404114 = 's'; // weak
char byte_404121 = '\x10'; // weak
char byte_404122 = 'n'; // weak
char byte_404123 = '\x05'; // weak
char byte_404124 = '\x04'; // weak
char byte_404125 = 'r'; // weak
char byte_404128 = 'p'; // weak
char byte_40412C = 't'; // weak
char byte_40412D = '`'; // weak
char byte_40412E = '\x02'; // weak
char byte_40412F = '='; // weak
char byte_404130 = '\f'; // weak
char byte_404135 = 'f'; // weak
char byte_404139 = '\x1B'; // weak
char _bss_start; // weak
_UNKNOWN end; // weak


//----- (0000000000401000) ----------------------------------------------------
__int64 (**init_proc())(void)
{
  __int64 (**result)(void); // rax

  result = &_gmon_start__;
  if ( &_gmon_start__ )
    result = (__int64 (**)(void))_gmon_start__();
  return result;
}
// 4041C8: using guessed type __int64 _gmon_start__(void);

//----- (0000000000401020) ----------------------------------------------------
__int64 sub_401020()
{
  return qword_404010();
}
// 404010: using guessed type __int64 (*qword_404010)(void);

//----- (0000000000401110) ----------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(__int64 a1@<rax>, void (*a2)(void)@<rdx>)
{
  int v2; // esi
  int v3; // [rsp-8h] [rbp-8h]
  __int64 _0; // [rsp+0h] [rbp+0h]

  v2 = v3;
  *(_QWORD *)&v3 = a1;
  _libc_start_main(
    (int (__cdecl *)(int, char **, char **))main,
    v2,
    (char **)&_0,
    (void (*)(void))_libc_csu_init,
    _libc_csu_fini,
    a2,
    &v3);
  __halt();
  JUMPOUT(*(_QWORD *)algn_40113B);
}
// 401116: positive sp value 8 has been found

//----- (0000000000401150) ----------------------------------------------------
void *deregister_tm_clones()
{
  void *result; // rax

  result = &end;
  if ( &end != &end )
    result = 0LL;
  return result;
}

//----- (0000000000401180) ----------------------------------------------------
__int64 register_tm_clones()
{
  return 0LL;
}

//----- (00000000004011C0) ----------------------------------------------------
void *_do_global_dtors_aux()
{
  void *result; // rax

  if ( !_bss_start )
  {
    result = deregister_tm_clones();
    _bss_start = 1;
  }
  return result;
}
// 404141: using guessed type char _bss_start;

//----- (00000000004011F2) ----------------------------------------------------
signed __int64 __fastcall check(const char *a1)
{
  size_t v2; // rbx
  char v3; // [rsp+15h] [rbp-2Bh]
  char v4; // [rsp+16h] [rbp-2Ah]
  char v5; // [rsp+17h] [rbp-29h]
  char v6; // [rsp+18h] [rbp-28h]
  char v7; // [rsp+19h] [rbp-27h]
  char v8; // [rsp+1Ah] [rbp-26h]
  char v9; // [rsp+1Bh] [rbp-25h]
  char v10; // [rsp+1Ch] [rbp-24h]
  char v11; // [rsp+1Dh] [rbp-23h]
  char v12; // [rsp+1Eh] [rbp-22h]
  char v13; // [rsp+1Fh] [rbp-21h]
  char v14; // [rsp+20h] [rbp-20h]
  char v15; // [rsp+21h] [rbp-1Fh]
  char v16; // [rsp+22h] [rbp-1Eh]
  char v17; // [rsp+23h] [rbp-1Dh]
  unsigned int j; // [rsp+24h] [rbp-1Ch]
  unsigned int i; // [rsp+28h] [rbp-18h]
  unsigned int v20; // [rsp+2Ch] [rbp-14h]

  v20 = 0;
  i = 0;
  j = 0;
  v3 = 105;
  v4 = 99;
  v5 = 101;
  v6 = 100;
  v7 = 111;
  v8 = 103;
  v9 = 102;
  v10 = 111;
  v11 = 120;
  v12 = 115;
  v13 = 117;
  v14 = 110;
  v15 = 69;
  v16 = 88;
  v17 = 71;
  while ( a1[v20] != 37 )
    ++v20;
  if ( ++v20 < strlen(a1) && a1[v20] > 96 && a1[v20] <= 122 )
    return 1LL;
  for ( i = v20; ; ++i )
  {
    v2 = i;
    if ( v2 >= strlen(a1) )
      break;
    for ( j = 0; j <= 0xE; ++j )
    {
      if ( (unsigned __int8)*(&v3 + j) == a1[i] )
        return 1LL;
    }
  }
  return 0LL;
}

//----- (000000000040130D) ----------------------------------------------------
__int64 stuff()
{
  char s; // [rsp+0h] [rbp-50h]
  char v2; // [rsp+4Fh] [rbp-1h]

  memset(&s, 0, 0x40uLL);
  printf("\nYour final message can be submitted here: ", 0LL);
  do
    v2 = getchar();
  while ( v2 != 10 && v2 != -1 );
  gets(&s);
  return 0LL;
}
// 4010A0: using guessed type __int64 __fastcall gets(_QWORD);

//----- (0000000000401369) ----------------------------------------------------
int __cdecl main(int argc, const char **argv, const char **envp)
{
  char v4; // [rsp+10h] [rbp-190h]
  char s; // [rsp+80h] [rbp-120h]
  int v6; // [rsp+E8h] [rbp-B8h]
  char dest; // [rsp+F0h] [rbp-B0h]
  int v8; // [rsp+158h] [rbp-48h]
  char name[8]; // [rsp+160h] [rbp-40h]
  __int64 v10; // [rsp+168h] [rbp-38h]
  int v11; // [rsp+170h] [rbp-30h]
  __int16 v12; // [rsp+174h] [rbp-2Ch]
  char v13; // [rsp+176h] [rbp-2Ah]
  __gid_t rgid; // [rsp+184h] [rbp-1Ch]
  void (__fastcall *v15)(char *, char *); // [rsp+188h] [rbp-18h]
  void *handle; // [rsp+190h] [rbp-10h]
  unsigned int i; // [rsp+19Ch] [rbp-4h]

  v13 = 0;
  name[0] = byte_404114;
  name[1] = byte_404128;
  name[2] = byte_404125;
  name[3] = byte_4040E0;
  name[4] = byte_404122;
  name[5] = byte_40412C;
  name[6] = byte_404135;
  name[7] = byte_404125;
  LOBYTE(v10) = byte_4040E0;
  BYTE1(v10) = byte_404130;
  BYTE2(v10) = byte_404121;
  BYTE3(v10) = byte_40412E;
  BYTE4(v10) = byte_404124;
  BYTE5(v10) = byte_404121;
  BYTE6(v10) = byte_4040E0;
  HIBYTE(v10) = byte_404123;
  LOBYTE(v11) = byte_40412F;
  BYTE1(v11) = byte_40412D;
  BYTE2(v11) = byte_404130;
  HIBYTE(v11) = byte_404121;
  LOBYTE(v12) = byte_40412E;
  HIBYTE(v12) = byte_404139;
  memset(&dest, 0, 0x68uLL);
  v8 = 0;
  memset(&s, 0, 0x68uLL);
  v6 = 0;
  memset(&v4, 0, 0x70uLL);
  memset(&s, 0, 0x6CuLL);
  memset(&dest, 0, 0x6CuLL);
  for ( i = 0; i <= 0x80; ++i )
  {
    if ( n2m[i] == 102 )
    {
      name[7] = 0;
      break;
    }
  }
  while ( !strncmp(&dest, &s, 0x6BuLL) )
  {
    printf("\nAdd a message to liberate: ");
    if ( (unsigned int)__isoc99_scanf("%107s", &s) == -1 || (unsigned int)check(&s) )
    {
      puts("\nDon't play around with the memory!");
      return 1;
    }
    strncpy(&dest, &s, 0x6BuLL);
    handle = dlopen(0LL, 1);
    if ( !handle )
    {
      dlclose(0LL);
      return 1;
    }
    v15 = (void (__fastcall *)(char *, char *))dlsym(handle, name);
    if ( !v15 )
    {
      puts("Symbol not found");
      return 1;
    }
    memset(&v4, 0, 0x70uLL);
    v15(&v4, &s); //sprintf
    printf("\nThe message you liberated is: '%s'", &v4);
    dlclose(handle);
  }
  rgid = getegid();
  setregid(rgid, rgid);
  stuff();
  return 0;
}
// 4010F0: using guessed type __int64 __fastcall __isoc99_scanf(_QWORD, _QWORD);
// 4040E0: using guessed type char byte_4040E0;
// 404114: using guessed type char byte_404114;
// 404121: using guessed type char byte_404121;
// 404122: using guessed type char byte_404122;
// 404123: using guessed type char byte_404123;
// 404124: using guessed type char byte_404124;
// 404125: using guessed type char byte_404125;
// 404128: using guessed type char byte_404128;
// 40412C: using guessed type char byte_40412C;
// 40412D: using guessed type char byte_40412D;
// 40412E: using guessed type char byte_40412E;
// 40412F: using guessed type char byte_40412F;
// 404130: using guessed type char byte_404130;
// 404135: using guessed type char byte_404135;
// 404139: using guessed type char byte_404139;

//----- (00000000004016D0) ----------------------------------------------------
void __fastcall _libc_csu_init(unsigned int a1, __int64 a2, __int64 a3)
{
  __int64 v3; // r15
  signed __int64 v4; // rbp
  __int64 v5; // rbx

  v3 = a3;
  init_proc();
  v4 = &_do_global_dtors_aux_fini_array_entry - &_frame_dummy_init_array_entry;
  if ( v4 )
  {
    v5 = 0LL;
    do
      ((void (__fastcall *)(_QWORD, __int64, __int64))*(&_frame_dummy_init_array_entry + v5++))(a1, a2, v3);
    while ( v4 != v5 );
  }
}
// 4011F0: using guessed type __int64 __fastcall frame_dummy(_QWORD, _QWORD, _QWORD);
// 403E00: using guessed type __int64 (__fastcall *_frame_dummy_init_array_entry)();
// 403E08: using guessed type __int64 (__fastcall *_do_global_dtors_aux_fini_array_entry)();

//----- (0000000000401734) ----------------------------------------------------
void term_proc()
{
  ;
}

// ALL OK, 11 function(s) have been successfully decompiled
